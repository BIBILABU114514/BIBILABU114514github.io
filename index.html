<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>关键词随机排列工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#8B5CF6',
                        neutral: '#64748B',
                        resultBg: '#F3F4F6',
                        locked: '#EF4444'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            .hover-lift {
                transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            }
            .hover-lift:hover {
                transform: translateY(-2px);
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            .btn-active {
                animation: buttonPress 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            }
            @keyframes buttonPress {
                0% { transform: scale(1); }
                50% { transform: scale(0.92); }
                100% { transform: scale(1); }
            }
            .fade-in {
                animation: fadeIn 0.3s ease-in-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .result-float {
                animation: float 3s ease-in-out infinite;
            }
            @keyframes float {
                0% { transform: translateY(0px); }
                50% { transform: translateY(-5px); }
                100% { transform: translateY(0px); }
            }
            .result-pop {
                animation: resultPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }
            @keyframes resultPop {
                0% { transform: scale(0.9); opacity: 0; }
                70% { transform: scale(1.05); }
                100% { transform: scale(1); opacity: 1; }
            }
            .masonry-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 1rem;
            }
            .entry-wrapper {
                position: relative;
                display: inline-flex;
                align-items: center;
            }
            .delete-btn-outside {
                position: absolute;
                right: -20px;
                top: 50%;
                transform: translateY(-50%);
                opacity: 0;
                transition: all 0.2s ease;
                cursor: pointer;
                z-index: 10;
                background: white;
                border-radius: 50%;
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .entry-wrapper:hover .delete-btn-outside {
                opacity: 1;
            }
            .delete-btn-outside:hover {
                color: #ef4444;
                transform: translateY(-50%) scale(1.1);
            }
            .entry {
                max-width: 200px;
            }
            .entry-text {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .result-highlight {
                /* 移除文字下的框 */
                box-shadow: none;
            }
            .lock-transition {
                transition: all 0.3s ease;
            }
        }
    </style>
</head>
<body class="min-h-screen font-sans text-gray-800 relative">
    <!-- 背景图 - 模糊处理 -->
    <div class="fixed inset-0 z-0">
        <img src="https://picsum.photos/id/1048/1920/1080" alt="抽象背景纹理" class="w-full h-full object-cover opacity-10 blur-md">
    </div>
    
    <div class="container mx-auto px-4 py-8 max-w-7xl relative z-10">
        <!-- 标题区域 -->
        <header class="text-center mb-6 fade-in">
            <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold text-primary mb-2">关键词随机排列工具</h1>
            <p class="text-gray-600 text-lg">自定义多列关键词，一键随机排列组合</p>
        </header>
        
        <!-- 结果预览区域 -->
        <div class="bg-white rounded-xl p-6 card-shadow fade-in mb-8" style="animation-delay: 0.1s">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fa fa-star text-primary"></i> 每列随机结果
            </h2>
            <div id="previewContainer" class="min-h-[140px] flex items-center justify-center p-6">
                <div class="text-gray-500 py-6">点击随机按钮生成每列结果</div>
            </div>
        </div>
        
        <!-- 控制区域 -->
        <div class="bg-white rounded-xl p-6 mb-8 card-shadow fade-in" style="animation-delay: 0.2s">
            <div class="flex flex-wrap gap-4 justify-center">
                <!-- 预设相关控制 -->
                <div class="flex flex-wrap gap-3 items-center">
                    <select id="presetSelect" class="border border-gray-300 rounded-lg px-4 py-3 bg-white text-gray-700 focus:outline-none focus:ring-2 focus:ring-primary/50">
                        <option value="">选择预设...</option>
                    </select>
                    <button id="editPresetName" class="flex items-center gap-2 bg-blue-400 hover:bg-blue-500 text-white px-3 py-3 rounded-lg font-medium hover-lift" disabled>
                        <i class="fa fa-pencil"></i> 重命名
                    </button>
                    <button id="savePreset" class="flex items-center gap-2 bg-accent hover:bg-accent/90 text-white px-4 py-3 rounded-lg font-medium hover-lift">
                        <i class="fa fa-save"></i> 保存预设
                    </button>
                    <button id="deletePreset" class="flex items-center gap-2 bg-red-400 hover:bg-red-500 text-white px-3 py-3 rounded-lg font-medium hover-lift" disabled>
                        <i class="fa fa-trash"></i> 删除
                    </button>
                </div>
                
                <!-- 原有控制按钮 -->
                <button id="addColumn" class="flex items-center gap-2 bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-lg font-medium hover-lift">
                    <i class="fa fa-plus-circle"></i> 添加列
                </button>
                <button id="randomAll" class="flex items-center gap-2 bg-secondary hover:bg-secondary/90 text-white px-6 py-3 rounded-lg font-medium hover-lift">
                    <i class="fa fa-random"></i> 生成每列随机结果
                </button>
                <button id="clearAll" class="flex items-center gap-2 bg-neutral hover:bg-neutral/90 text-white px-6 py-3 rounded-lg font-medium hover-lift">
                    <i class="fa fa-trash"></i> 清空所有
                </button>
                <button id="toggleAllLocks" class="flex items-center gap-2 bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-medium hover-lift">
                    <i class="fa fa-lock"></i> 全部锁定
                </button>
            </div>
        </div>
        
        <!-- 列容器 -->
        <div id="columnsContainer" class="flex flex-wrap gap-6 mb-10">
            <!-- 初始列 - 主体 -->
            <div class="column bg-white rounded-xl p-5 card-shadow flex-1 min-w-[280px] fade-in" style="animation-delay: 0.3s">
                <div class="flex items-center justify-between mb-4">
                    <input type="text" class="column-title text-xl font-semibold text-gray-800 border-b-2 border-primary p-2 w-full focus:outline-none focus:border-primary/80 transition-colors" value="主体" placeholder="列标题">
                    <button class="delete-column text-gray-400 hover:text-red-500 p-2 transition-colors ml-2" title="删除列">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                
                <!-- 列随机结果显示框 - 优化布局和样式 -->
                <div class="column-result border-2 border-primary/30 bg-resultBg rounded-xl p-4 mb-5 result-float lock-transition">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-sm text-gray-500 whitespace-nowrap">当前选择：</span>
                            <div class="column-result-text flex-1 font-bold text-xl text-primary rounded-lg text-center py-2 result-highlight">
                                -
                            </div>
                        </div>
                        <button class="lock-column ml-2 p-2 text-gray-400 hover:text-locked lock-transition" title="锁定/解锁">
                            <i class="fa fa-unlock"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 按钮区域 - 添加词条和随机此列并排 -->
                <div class="flex gap-3 mb-4">
                    <button class="add-entry flex-1 flex items-center justify-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-3 rounded-lg font-medium hover-lift">
                        <i class="fa fa-plus"></i> 添加词条
                    </button>
                    <button class="random-column bg-primary/10 hover:bg-primary/20 text-primary p-3 rounded-lg hover-lift">
                        <i class="fa fa-refresh"></i> 随机
                    </button>
                </div>
                
                <!-- 瀑布流布局的词条容器 -->
                <div class="entries-container masonry-grid max-h-[300px] overflow-y-auto pr-6 border rounded-lg p-3 bg-gray-50">
                    <div class="entry-wrapper">
                        <div class="entry p-3 bg-white rounded-lg hover:bg-gray-50 transition-colors shadow-sm">
                            <input type="text" class="entry-text bg-transparent border-none focus:outline-none w-full" value="森林" placeholder="输入关键词">
                        </div>
                        <button class="delete-btn-outside text-gray-500">
                            <i class="fa fa-times-circle"></i>
                        </button>
                    </div>
                    <div class="entry-wrapper">
                        <div class="entry p-3 bg-white rounded-lg hover:bg-gray-50 transition-colors shadow-sm">
                            <input type="text" class="entry-text bg-transparent border-none focus:outline-none w-full" value="海洋" placeholder="输入关键词">
                        </div>
                        <button class="delete-btn-outside text-gray-500">
                            <i class="fa fa-times-circle"></i>
                        </button>
                    </div>
                    <div class="entry-wrapper">
                        <div class="entry p-3 bg-white rounded-lg hover:bg-gray-50 transition-colors shadow-sm">
                            <input type="text" class="entry-text bg-transparent border-none focus:outline-none w-full" value="城市" placeholder="输入关键词">
                        </div>
                        <button class="delete-btn-outside text-gray-500">
                            <i class="fa fa-times-circle"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 初始列 - 风格 -->
            <div class="column bg-white rounded-xl p-5 card-shadow flex-1 min-w-[280px] fade-in" style="animation-delay: 0.4s">
                <div class="flex items-center justify-between mb-4">
                    <input type="text" class="column-title text-xl font-semibold text-gray-800 border-b-2 border-primary p-2 w-full focus:outline-none focus:border-primary/80 transition-colors" value="风格" placeholder="列标题">
                    <button class="delete-column text-gray-400 hover:text-red-500 p-2 transition-colors ml-2" title="删除列">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                
                <!-- 列随机结果显示框 - 优化布局和样式 -->
                <div class="column-result border-2 border-primary/30 bg-resultBg rounded-xl p-4 mb-5 result-float lock-transition">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-sm text-gray-500 whitespace-nowrap">当前选择：</span>
                            <div class="column-result-text flex-1 font-bold text-xl text-primary rounded-lg text-center py-2 result-highlight">
                                -
                            </div>
                        </div>
                        <button class="lock-column ml-2 p-2 text-gray-400 hover:text-locked lock-transition" title="锁定/解锁">
                            <i class="fa fa-unlock"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 按钮区域 - 添加词条和随机此列并排 -->
                <div class="flex gap-3 mb-4">
                    <button class="add-entry flex-1 flex items-center justify-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-3 rounded-lg font-medium hover-lift">
                        <i class="fa fa-plus"></i> 添加词条
                    </button>
                    <button class="random-column bg-primary/10 hover:bg-primary/20 text-primary p-3 rounded-lg hover-lift">
                        <i class="fa fa-refresh"></i> 随机
                    </button>
                </div>
                
                <!-- 瀑布流布局的词条容器 -->
                <div class="entries-container masonry-grid max-h-[300px] overflow-y-auto pr-6 border rounded-lg p-3 bg-gray-50">
                    <div class="entry-wrapper">
                        <div class="entry p-3 bg-white rounded-lg hover:bg-gray-50 transition-colors shadow-sm">
                            <input type="text" class="entry-text bg-transparent border-none focus:outline-none w-full" value="极简主义" placeholder="输入关键词">
                        </div>
                        <button class="delete-btn-outside text-gray-500">
                            <i class="fa fa-times-circle"></i>
                        </button>
                    </div>
                    <div class="entry-wrapper">
                        <div class="entry p-3 bg-white rounded-lg hover:bg-gray-50 transition-colors shadow-sm">
                            <input type="text" class="entry-text bg-transparent border-none focus:outline-none w-full" value="赛博朋克" placeholder="输入关键词">
                        </div>
                        <button class="delete-btn-outside text-gray-500">
                            <i class="fa fa-times-circle"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 预设管理提示 -->
        <div id="presetNotification" class="fixed bottom-5 right-5 bg-gray-800 text-white px-5 py-3 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 flex items-center gap-2 z-50">
            <i class="fa fa-info-circle"></i>
            <span id="notificationText"></span>
        </div>
        
        <!-- 页脚 -->
        <footer class="mt-12 text-center text-gray-500 text-sm">
            <p>关键词随机排列工具 &copy; 2023</p>
        </footer>
    </div>

    <script>
        // DOM 元素
        const columnsContainer = document.getElementById('columnsContainer');
        const addColumnBtn = document.getElementById('addColumn');
        const randomAllBtn = document.getElementById('randomAll');
        const clearAllBtn = document.getElementById('clearAll');
        const toggleAllLocksBtn = document.getElementById('toggleAllLocks');
        const previewContainer = document.getElementById('previewContainer');
        const presetSelect = document.getElementById('presetSelect');
        const savePresetBtn = document.getElementById('savePreset');
        const editPresetNameBtn = document.getElementById('editPresetName');
        const deletePresetBtn = document.getElementById('deletePreset');
        const presetNotification = document.getElementById('presetNotification');
        const notificationText = document.getElementById('notificationText');
        
        // 初始化列计数器
        let columnCounter = document.querySelectorAll('.column').length;
        // 预设数据存储
        let presets = [];
        // 跟踪是否全部锁定
        let allLocked = false;
        
        // 添加按钮点击反馈效果
        function setupButtonFeedback(button) {
            button.addEventListener('click', function() {
                this.classList.remove('btn-active');
                void this.offsetWidth;
                this.classList.add('btn-active');
            });
        }
        
        // 检查是否有重复词条 - 修复bug：只有当新输入的值非空且确实存在重复时才返回true
        function hasDuplicateEntry(container, newValue) {
            const trimmedValue = newValue.trim();
            if (!trimmedValue) return false; // 空值不视为重复
            
            const entries = container.querySelectorAll('.entry-text');
            const normalizedValue = trimmedValue.toLowerCase();
            let duplicateCount = 0;
            
            for (let entry of entries) {
                if (entry.value.trim().toLowerCase() === normalizedValue) {
                    duplicateCount++;
                    if (duplicateCount > 1) { // 允许一个已存在的值，超过一个才视为重复
                        return true;
                    }
                }
            }
            return false;
        }
        
        // 切换列的锁定状态 - 修复锁定状态同步问题
        function toggleColumnLock(lockButton) {
            const resultContainer = lockButton.closest('.column-result');
            const isLocked = resultContainer.classList.contains('locked');
            
            if (isLocked) {
                // 解锁 - 恢复动画和交互
                resultContainer.classList.remove('locked', 'border-locked', 'bg-gray-100');
                resultContainer.classList.add('result-float');
                lockButton.innerHTML = '<i class="fa fa-unlock"></i>';
                lockButton.title = '锁定';
            } else {
                // 锁定 - 停止动画和交互
                resultContainer.classList.add('locked', 'border-locked', 'bg-gray-100');
                resultContainer.classList.remove('result-float');
                lockButton.innerHTML = '<i class="fa fa-lock"></i>';
                lockButton.title = '解锁';
            }
            
            updateAllLockStatus();
            updatePreview(); // 立即更新预览，确保锁定状态同步显示
        }
        
        // 更新全选锁定按钮状态
        function updateAllLockStatus() {
            const allColumns = document.querySelectorAll('.column-result');
            const lockedColumns = document.querySelectorAll('.column-result.locked');
            
            allLocked = allColumns.length > 0 && allColumns.length === lockedColumns.length;
            
            if (allLocked) {
                toggleAllLocksBtn.innerHTML = '<i class="fa fa-unlock"></i> 全部解锁';
                toggleAllLocksBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                toggleAllLocksBtn.classList.add('bg-locked', 'hover:bg-red-600');
            } else {
                toggleAllLocksBtn.innerHTML = '<i class="fa fa-lock"></i> 全部锁定';
                toggleAllLocksBtn.classList.remove('bg-locked', 'hover:bg-red-600');
                toggleAllLocksBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
            }
        }
        
        // 切换所有列的锁定状态
        function toggleAllLocks() {
            const lockButtons = document.querySelectorAll('.lock-column');
            
            if (allLocked) {
                // 全部解锁
                lockButtons.forEach(button => {
                    const resultContainer = button.closest('.column-result');
                    if (resultContainer.classList.contains('locked')) {
                        toggleColumnLock(button);
                    }
                });
                showNotification('已解锁所有列');
            } else {
                // 全部锁定
                lockButtons.forEach(button => {
                    const resultContainer = button.closest('.column-result');
                    if (!resultContainer.classList.contains('locked')) {
                        toggleColumnLock(button);
                    }
                });
                showNotification('已锁定所有列');
            }
        }
        
        // 初始化预设系统
        function initPresets() {
            try {
                const stored = localStorage.getItem('keywordPresets');
                if (stored) {
                    presets = JSON.parse(stored);
                } else {
                    presets = [];
                }
            } catch (e) {
                console.error('加载预设失败:', e);
                presets = [];
                localStorage.removeItem('keywordPresets');
            }
            initPresetSelect();
        }
        
        // 初始化预设选择下拉框
        function initPresetSelect() {
            const currentValue = presetSelect.value;
            
            while (presetSelect.options.length > 1) {
                presetSelect.remove(1);
            }
            
            presets.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.id;
                option.textContent = `${preset.name} (${preset.columns.length}列)`;
                presetSelect.appendChild(option);
            });
            
            if (currentValue && presets.some(p => p.id === currentValue)) {
                presetSelect.value = currentValue;
            } else {
                presetSelect.value = '';
            }
            
            updatePresetButtons();
        }
        
        // 更新预设按钮状态
        function updatePresetButtons() {
            const hasSelected = !!presetSelect.value;
            
            deletePresetBtn.disabled = !hasSelected;
            deletePresetBtn.classList.toggle('opacity-50', !hasSelected);
            deletePresetBtn.classList.toggle('cursor-not-allowed', !hasSelected);
            
            editPresetNameBtn.disabled = !hasSelected;
            editPresetNameBtn.classList.toggle('opacity-50', !hasSelected);
            editPresetNameBtn.classList.toggle('cursor-not-allowed', !hasSelected);
        }
        
        // 显示通知
        function showNotification(message) {
            notificationText.textContent = message;
            presetNotification.classList.remove('opacity-0');
            presetNotification.classList.add('opacity-100');
            
            setTimeout(() => {
                presetNotification.classList.remove('opacity-100');
                presetNotification.classList.add('opacity-0');
            }, 3000);
        }
        
        // 添加新列
        function addColumn(title = `列 ${columnCounter + 1}`) {
            columnCounter++;
            
            const newColumn = document.createElement('div');
            newColumn.className = 'column bg-white rounded-xl p-5 card-shadow flex-1 min-w-[280px] fade-in';
            
            newColumn.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <input type="text" class="column-title text-xl font-semibold text-gray-800 border-b-2 border-primary p-2 w-full focus:outline-none focus:border-primary/80 transition-colors" value="${title}" placeholder="列标题">
                    <button class="delete-column text-gray-400 hover:text-red-500 p-2 transition-colors ml-2" title="删除列">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                
                <!-- 列随机结果显示框 - 优化布局和样式 -->
                <div class="column-result border-2 border-primary/30 bg-resultBg rounded-xl p-4 mb-5 result-float lock-transition">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-sm text-gray-500 whitespace-nowrap">当前选择：</span>
                            <div class="column-result-text flex-1 font-bold text-xl text-primary rounded-lg text-center py-2 result-highlight">
                                -
                            </div>
                        </div>
                        <button class="lock-column ml-2 p-2 text-gray-400 hover:text-locked lock-transition" title="锁定/解锁">
                            <i class="fa fa-unlock"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 按钮区域 - 添加词条和随机此列并排 -->
                <div class="flex gap-3 mb-4">
                    <button class="add-entry flex-1 flex items-center justify-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-3 rounded-lg font-medium hover-lift">
                        <i class="fa fa-plus"></i> 添加词条
                    </button>
                    <button class="random-column bg-primary/10 hover:bg-primary/20 text-primary p-3 rounded-lg hover-lift">
                        <i class="fa fa-refresh"></i> 随机
                    </button>
                </div>
                
                <!-- 瀑布流布局的词条容器 -->
                <div class="entries-container masonry-grid max-h-[300px] overflow-y-auto pr-6 border rounded-lg p-3 bg-gray-50">
                </div>
            `;
            
            columnsContainer.appendChild(newColumn);
            
            // 添加事件监听器
            setupColumnEventListeners(newColumn);
            updateAllLockStatus();
            
            return newColumn;
        }
        
        // 为列设置事件监听器
        function setupColumnEventListeners(column) {
            // 删除列按钮
            const deleteBtn = column.querySelector('.delete-column');
            deleteBtn.addEventListener('click', () => {
                if (document.querySelectorAll('.column').length <= 1) {
                    showNotification('至少保留一列');
                    return;
                }
                
                column.classList.add('opacity-0', 'scale-95');
                column.style.transition = 'all 0.3s ease';
                
                setTimeout(() => {
                    column.remove();
                    updatePreview();
                    updateAllLockStatus();
                }, 300);
            });
            setupButtonFeedback(deleteBtn);
            
            // 添加词条按钮
            const addEntryBtn = column.querySelector('.add-entry');
            addEntryBtn.addEventListener('click', () => {
                addEntry(column.querySelector('.entries-container'));
            });
            setupButtonFeedback(addEntryBtn);
            
            // 随机此列按钮
            const randomBtn = column.querySelector('.random-column');
            randomBtn.addEventListener('click', () => {
                // 检查是否锁定
                const resultContainer = column.querySelector('.column-result');
                if (!resultContainer.classList.contains('locked')) {
                    randomizeColumn(column);
                    updatePreview();
                } else {
                    showNotification('此列已锁定，请先解锁');
                }
            });
            setupButtonFeedback(randomBtn);
            
            // 锁定按钮
            const lockBtn = column.querySelector('.lock-column');
            lockBtn.addEventListener('click', () => {
                toggleColumnLock(lockBtn);
            });
            setupButtonFeedback(lockBtn);
            
            // 列标题变化时更新预览
            const titleInput = column.querySelector('.column-title');
            titleInput.addEventListener('input', updatePreview);
        }
        
        // 添加新词条
        function addEntry(container) {
            const entryWrapper = document.createElement('div');
            entryWrapper.className = 'entry-wrapper fade-in';
            
            entryWrapper.innerHTML = `
                <div class="entry p-3 bg-white rounded-lg hover:bg-gray-50 transition-colors shadow-sm">
                    <input type="text" class="entry-text bg-transparent border-none focus:outline-none w-full" placeholder="输入关键词">
                </div>
                <button class="delete-btn-outside text-gray-500">
                    <i class="fa fa-times-circle"></i>
                </button>
            `;
            
            container.appendChild(entryWrapper);
            
            // 删除词条按钮
            const deleteBtn = entryWrapper.querySelector('.delete-btn-outside');
            deleteBtn.addEventListener('click', () => {
                entryWrapper.classList.add('opacity-0', 'scale-90');
                entryWrapper.style.transition = 'all 0.2s ease';
                
                setTimeout(() => {
                    entryWrapper.remove();
                }, 200);
            });
            setupButtonFeedback(deleteBtn);
            
            // 词条输入框事件 - 修复重复检查bug
            const entryInput = entryWrapper.querySelector('.entry-text');
            entryInput.addEventListener('blur', function() {
                const value = this.value;
                // 只有当输入值非空且确实存在重复时才删除
                if (value.trim() && hasDuplicateEntry(container, value)) {
                    // 找到重复的条目并高亮
                    const entries = container.querySelectorAll('.entry-text');
                    for (let entry of entries) {
                        if (entry !== this && entry.value.trim().toLowerCase() === value.trim().toLowerCase()) {
                            entry.closest('.entry').classList.add('bg-red-50', 'border', 'border-red-200');
                            setTimeout(() => {
                                entry.closest('.entry').classList.remove('bg-red-50', 'border', 'border-red-200');
                            }, 2000);
                            break;
                        }
                    }
                    
                    // 删除重复的新条目
                    entryWrapper.classList.add('opacity-0', 'scale-90');
                    entryWrapper.style.transition = 'all 0.2s ease';
                    showNotification('已删除重复词条');
                    
                    setTimeout(() => {
                        entryWrapper.remove();
                    }, 200);
                }
            });
            
            // 自动聚焦到新添加的输入框
            setTimeout(() => {
                entryInput.focus();
            }, 100);
        }
        
        // 随机选择一列中的词条
        function randomizeColumn(column) {
            const entriesContainer = column.querySelector('.entries-container');
            const entries = entriesContainer.querySelectorAll('.entry-text');
            const resultElement = column.querySelector('.column-result-text');
            
            // 收集非空词条
            const validEntries = Array.from(entries)
                .map(entry => entry.value.trim())
                .filter(value => value);
            
            // 移除动画类以重新触发
            resultElement.classList.remove('result-pop');
            
            if (validEntries.length === 0) {
                resultElement.textContent = '-';
                // 触发重绘
                void resultElement.offsetWidth;
                resultElement.classList.add('result-pop');
                return null;
            }
            
            // 随机选择一个词条
            const randomIndex = Math.floor(Math.random() * validEntries.length);
            const selectedEntry = validEntries[randomIndex];
            
            // 更新结果显示并添加动画效果
            resultElement.textContent = selectedEntry;
            // 触发重绘
            void resultElement.offsetWidth;
            resultElement.classList.add('result-pop');
            
            return selectedEntry;
        }
        
        // 随机所有列
        function randomizeAllColumns() {
            const columns = document.querySelectorAll('.column');
            let unlockedColumns = 0;
            
            // 先移除所有动画类
            columns.forEach(column => {
                const resultContainer = column.querySelector('.column-result');
                // 只处理未锁定的列
                if (!resultContainer.classList.contains('locked')) {
                    unlockedColumns++;
                    const resultElement = column.querySelector('.column-result-text');
                    resultElement.classList.remove('result-pop');
                }
            });
            
            if (unlockedColumns === 0) {
                showNotification('所有列都已锁定，请先解锁至少一列');
                return;
            }
            
            // 强制重绘
            void document.body.offsetWidth;
            
            // 同时为所有未锁定列应用动画和随机结果
            columns.forEach(column => {
                const resultContainer = column.querySelector('.column-result');
                if (!resultContainer.classList.contains('locked')) {
                    randomizeColumn(column);
                }
            });
            
            updatePreview();
        }
        
        // 清空所有内容
        function clearAll() {
            if (confirm('确定要清空所有列和关键词吗？')) {
                // 保留第一列，清空其他列
                const columns = document.querySelectorAll('.column');
                columns.forEach((column, index) => {
                    if (index > 0) {
                        column.remove();
                    } else {
                        // 清空第一列的内容但保留列本身
                        const entriesContainer = column.querySelector('.entries-container');
                        entriesContainer.innerHTML = '';
                        column.querySelector('.column-result-text').textContent = '-';
                        column.querySelector('.column-title').value = '列 1';
                        
                        // 解锁第一列
                        const resultContainer = column.querySelector('.column-result');
                        const lockButton = column.querySelector('.lock-column');
                        if (resultContainer.classList.contains('locked')) {
                            toggleColumnLock(lockButton);
                        }
                    }
                });
                
                columnCounter = 1;
                updatePreview();
                updateAllLockStatus();
                showNotification('已清空所有内容');
            }
        }
        
        // 更新预览区域
        function updatePreview() {
            const columns = document.querySelectorAll('.column');
            const previewItems = [];
            
            columns.forEach(column => {
                const title = column.querySelector('.column-title').value || '未命名列';
                const result = column.querySelector('.column-result-text').textContent;
                const isLocked = column.querySelector('.column-result').classList.contains('locked');
                
                previewItems.push(`
                    <div class="flex flex-col items-center p-4 m-2 flex-shrink-0 border-2 ${isLocked ? 'border-locked' : 'border-primary/30'} 
                                ${isLocked ? 'bg-gray-100' : 'bg-resultBg'} rounded-xl ${!isLocked ? 'result-float' : ''} min-w-[180px]">
                        <div class="flex items-center justify-between w-full mb-1">
                            <span class="text-base text-gray-600 font-medium">${title}</span>
                            ${isLocked ? '<i class="fa fa-lock text-locked"></i>' : ''}
                        </div>
                        <div class="px-4 py-2 bg-white text-primary font-bold text-lg rounded-lg result-highlight min-w-[120px] text-center">
                            ${result}
                        </div>
                    </div>
                `);
            });
            
            if (previewItems.length === 0) {
                previewContainer.innerHTML = '<div class="text-gray-500 py-6">请添加列和关键词</div>';
            } else {
                previewContainer.innerHTML = `
                    <div class="flex flex-wrap justify-center gap-6 w-full py-4">
                        ${previewItems.join('')}
                    </div>
                `;
            }
        }
        
        // 保存当前配置为预设
        function saveCurrentAsPreset() {
            const presetName = prompt('请输入预设名称:', `预设 ${presets.length + 1}`);
            
            if (!presetName || !presetName.trim()) {
                showNotification('预设名称不能为空');
                return;
            }
            
            // 收集当前列数据，包括锁定状态
            const columns = document.querySelectorAll('.column');
            const columnsData = Array.from(columns).map(column => {
                const title = column.querySelector('.column-title').value || '';
                const entries = Array.from(column.querySelectorAll('.entry-text'))
                    .map(entry => entry.value.trim())
                    .filter(value => value);
                const isLocked = column.querySelector('.column-result').classList.contains('locked');
                const currentValue = column.querySelector('.column-result-text').textContent;
                
                return { title, entries, isLocked, currentValue };
            });
            
            if (columnsData.length === 0) {
                showNotification('至少保留一列才能保存预设');
                return;
            }
            
            // 创建新预设
            const newPreset = {
                id: Date.now().toString(),
                name: presetName.trim(),
                columns: columnsData,
                createdAt: new Date().toISOString()
            };
            
            // 检查是否是更新现有预设
            const selectedPresetId = presetSelect.value;
            if (selectedPresetId) {
                const index = presets.findIndex(p => p.id === selectedPresetId);
                if (index !== -1) {
                    presets[index] = newPreset;
                    showNotification(`已更新预设: ${presetName}`);
                } else {
                    presets.push(newPreset);
                    showNotification(`已保存新预设: ${presetName}`);
                }
            } else {
                presets.push(newPreset);
                showNotification(`已保存新预设: ${presetName}`);
            }
            
            // 保存到本地存储
            localStorage.setItem('keywordPresets', JSON.stringify(presets));
            initPresetSelect();
            
            // 选中新创建的预设
            presetSelect.value = newPreset.id;
            updatePresetButtons();
        }
        
        // 加载选中的预设
        function loadSelectedPreset() {
            const presetId = presetSelect.value;
            if (!presetId) return;
            
            const preset = presets.find(p => p.id === presetId);
            if (!preset) return;
            
            // 清空现有列
            columnsContainer.innerHTML = '';
            columnCounter = 0;
            
            // 添加预设中的列
            preset.columns.forEach(colData => {
                const newColumn = addColumn(colData.title);
                const entriesContainer = newColumn.querySelector('.entries-container');
                const resultContainer = newColumn.querySelector('.column-result');
                const lockButton = newColumn.querySelector('.lock-column');
                const resultText = newColumn.querySelector('.column-result-text');
                
                // 设置当前值
                resultText.textContent = colData.currentValue || '-';
                
                // 添加词条
                colData.entries.forEach(entryText => {
                    const entryWrapper = document.createElement('div');
                    entryWrapper.className = 'entry-wrapper';
                    
                    entryWrapper.innerHTML = `
                        <div class="entry p-3 bg-white rounded-lg hover:bg-gray-50 transition-colors shadow-sm">
                            <input type="text" class="entry-text bg-transparent border-none focus:outline-none w-full" value="${entryText}" placeholder="输入关键词">
                        </div>
                        <button class="delete-btn-outside text-gray-500">
                            <i class="fa fa-times-circle"></i>
                        </button>
                    `;
                    
                    entriesContainer.appendChild(entryWrapper);
                    
                    // 删除词条按钮事件
                    const deleteBtn = entryWrapper.querySelector('.delete-btn-outside');
                    deleteBtn.addEventListener('click', () => {
                        entryWrapper.remove();
                    });
                    setupButtonFeedback(deleteBtn);
                    
                    // 添加重复检查事件
                    const entryInput = entryWrapper.querySelector('.entry-text');
                    entryInput.addEventListener('blur', function() {
                        const value = this.value;
                        if (value.trim() && hasDuplicateEntry(entriesContainer, value)) {
                            entryWrapper.classList.add('opacity-0', 'scale-90');
                            entryWrapper.style.transition = 'all 0.2s ease';
                            showNotification('已删除重复词条');
                            
                            setTimeout(() => {
                                entryWrapper.remove();
                            }, 200);
                        }
                    });
                });
                
                // 应用锁定状态
                if (colData.isLocked) {
                    toggleColumnLock(lockButton);
                }
            });
            
            updatePreview();
            updateAllLockStatus();
            showNotification(`已加载预设: ${preset.name}`);
        }
        
        // 编辑预设名称
        function editSelectedPresetName() {
            const presetId = presetSelect.value;
            if (!presetId) return;
            
            const preset = presets.find(p => p.id === presetId);
            if (!preset) return;
            
            const newName = prompt('修改预设名称:', preset.name);
            if (!newName || !newName.trim()) {
                showNotification('预设名称不能为空');
                return;
            }
            
            preset.name = newName.trim();
            localStorage.setItem('keywordPresets', JSON.stringify(presets));
            initPresetSelect();
            showNotification(`已更新预设名称: ${newName}`);
        }
        
        // 删除选中的预设
        function deleteSelectedPreset() {
            const presetId = presetSelect.value;
            if (!presetId) return;
            
            const preset = presets.find(p => p.id === presetId);
            if (!preset) return;
            
            if (confirm(`确定要删除预设 "${preset.name}" 吗？`)) {
                presets = presets.filter(p => p.id !== presetId);
                localStorage.setItem('keywordPresets', JSON.stringify(presets));
                initPresetSelect();
                showNotification(`已删除预设: ${preset.name}`);
            }
        }
        
        // 初始化事件监听器
        function initEventListeners() {
            // 添加列按钮
            addColumnBtn.addEventListener('click', addColumn);
            setupButtonFeedback(addColumnBtn);
            
            // 随机所有列按钮
            randomAllBtn.addEventListener('click', randomizeAllColumns);
            setupButtonFeedback(randomAllBtn);
            
            // 清空所有按钮
            clearAllBtn.addEventListener('click', clearAll);
            setupButtonFeedback(clearAllBtn);
            
            // 全部锁定/解锁按钮
            toggleAllLocksBtn.addEventListener('click', toggleAllLocks);
            setupButtonFeedback(toggleAllLocksBtn);
            
            // 预设相关按钮
            savePresetBtn.addEventListener('click', saveCurrentAsPreset);
            setupButtonFeedback(savePresetBtn);
            
            editPresetNameBtn.addEventListener('click', editSelectedPresetName);
            setupButtonFeedback(editPresetNameBtn);
            
            deletePresetBtn.addEventListener('click', deleteSelectedPreset);
            setupButtonFeedback(deletePresetBtn);
            
            presetSelect.addEventListener('change', loadSelectedPreset);
            
            // 为初始列设置事件监听器
            document.querySelectorAll('.column').forEach(setupColumnEventListeners);
            
            // 初始化预览
            updatePreview();
        }
        
        // 初始化
        function init() {
            initPresets();
            initEventListeners();
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
    
